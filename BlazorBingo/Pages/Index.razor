@page "/"
@implements IDisposable
@inject GameSettings settings
@inject NavigationManager Navigation

<PageTitle>Blazor Bingo</PageTitle>

<h1>Blazor Bingo</h1>

<div class="row mb-2">
    <label for="playerName" class="col-sm-2 col-form-label">Name</label>
    <div class="col-auto">
        <input type="text" id="playerName" class="form-control" @bind="playerName" @bind:after="SavePlayerNameAsync" placeholder="player name" maxlength="32" />
    </div>
    <div class="col-auto">
        <a role="button" class="btn btn-outline-secondary" title="Host" href="./host">Host</a>
    </div>
</div>
<div class="row mb-2">
    <label for="gameCode" class="col-sm-2 col-form-label">Bingo Hall</label>
    <div class="col-auto">
        <input type="text" id="gameCode" class="form-control gameCode" 
        @bind:event="oninput" @bind:get="gameCode" @bind:set="OnGameCodeInput" 
        placeholder="enter code" maxlength="4" minlength="4" pattern="[b-df-hj-np-tv-zB-DF-HJ-NP-TV-Z]{4}" />
    </div>
    <div class="col-auto">
        <button type="button" class="btn btn-primary" @onclick="Join" disabled="@(!canJoin)">Join</button>
    </div>
</div>
<div class="row mb-2">
    <div class="col-sm-2"></div>
    <div class="col-auto">
        <small>version <code style="color: inherit;">23.01.16.01</code></small>
    </div>
    <div class="col-auto">
        <a role="button" class="symbolbutton" title="Settings" href="./settings"><span class="gear"></span></a>
    </div>
</div>
                                                                       
@code {
    protected string gameCode = string.Empty;
    protected string playerName = string.Empty;
    protected bool canJoin;

    protected override void OnInitialized()
    {
        settings.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        settings.OnChange -= StateHasChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await settings.LoadAsync();
        playerName = settings.PlayerName;
#if DEBUG
    gameCode = "0000";
    RefreshCanJoin();
#endif
    }

    private void RefreshCanJoin()
    {
        canJoin =
            !string.IsNullOrWhiteSpace(playerName) &&
            !string.IsNullOrWhiteSpace(gameCode) &&
            gameCode.Length == 4;

    }
    protected async Task SavePlayerNameAsync()
    {
        RefreshCanJoin();
    }

    protected void OnGameCodeInput(string value)
    {
        gameCode = value;
        RefreshCanJoin();
    }

    protected void Join()
    {
        settings!.PlayerName = playerName;
        Navigation.NavigateTo($"./play/{gameCode.ToUpperInvariant()}");
    }
}